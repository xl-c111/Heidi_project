<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post-Surgery Care Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
            padding: 30px;
            color: white;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .steps {
            padding: 30px;
        }

        .step {
            margin-bottom: 40px;
            padding: 25px;
            border-radius: 15px;
            border-left: 5px solid #4facfe;
            background: #f8fafc;
        }

        .step h2 {
            color: #1e293b;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .upload-area {
            border: 2px dashed #4facfe;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .upload-area:hover {
            border-color: #00f2fe;
            background: #f0f9ff;
        }

        .upload-area.dragover {
            border-color: #00f2fe;
            background: #e0f2fe;
        }

        .file-input {
            display: none;
        }

        .upload-text {
            font-size: 1.1rem;
            color: #64748b;
            margin-bottom: 10px;
        }

        .upload-subtext {
            color: #94a3b8;
            font-size: 0.9rem;
        }

        .text-input-area {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }

        .text-input-area textarea {
            width: 100%;
            min-height: 120px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 15px;
            font-family: inherit;
            font-size: 0.95rem;
            resize: vertical;
        }

        .care-plan {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            display: none;
            border: 2px solid #10b981;
        }

        .care-plan.show {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .care-section {
            margin-bottom: 25px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 4px solid #4facfe;
        }

        .care-section h3 {
            color: #1e293b;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .care-item {
            background: white;
            padding: 10px;
            margin: 8px 0;
            border-radius: 6px;
            border-left: 2px solid #e2e8f0;
        }

        .btn {
            background: #4facfe;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .btn:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #4facfe;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 3px solid #e2e8f0;
            border-top: 3px solid #4facfe;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .voice-section {
            background: #fef3f2;
            border-left-color: #10b981;
        }

        .record-btn {
            background: #10b981;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            margin: 10px auto;
            display: block;
            transition: all 0.3s ease;
        }

        .record-btn:hover {
            background: #059669;
            transform: scale(1.1);
        }

        .record-btn.recording {
            background: #ef4444;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .chat-response {
            background: #ecfdf5;
            border: 1px solid #10b981;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }

        .chat-response.show {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }

        .text-question-area {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }

        .text-question-area input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.95rem;
        }

        .ask-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 8px;
            font-size: 0.9rem;
        }

        .ask-btn:hover {
            background: #059669;
        }

        .ask-btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #ef4444;
            color: #dc2626;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .success-message {
            background: #dcfce7;
            border: 1px solid #16a34a;
            color: #166534;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            display: none;
        }

        .success-message.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè• Post-Surgery Care Assistant</h1>
            <p>Upload your discharge papers to get a personalized care plan</p>
        </div>

        <div class="steps">
            <!-- Step 1: Document Upload -->
            <div class="step">
                <h2>üìã Step 1: Upload Your Medical Documents</h2>
                <div class="upload-area" onclick="document.getElementById('file-input').click()">
                    <div class="upload-text">üìÑ Click to upload or drag & drop</div>
                    <div class="upload-subtext">Discharge papers, prescription lists, care instructions (JPG, PNG, PDF)</div>
                </div>
                <input type="file" id="file-input" class="file-input" accept=".jpg,.jpeg,.png,.pdf" onchange="handleFileUpload(event)">

                <!-- Manual text input area -->
                <div class="text-input-area">
                    <h4 style="margin-bottom: 10px;">Or paste your discharge instructions here:</h4>
                    <textarea id="document-text" placeholder="Example: Patient discharged after knee surgery. Take Ibuprofen 400mg every 6 hours with food. Short walks recommended every 2 hours. No lifting over 10 pounds for 2 weeks. Follow-up appointment in 1 week. Watch for fever, redness, or unusual swelling..."></textarea>
                    <button class="btn" onclick="processDocumentText()" id="process-btn">üìã Generate Care Plan</button>
                </div>

                <div class="loading" id="upload-loading">
                    <div class="spinner"></div>
                    <p>Processing your document and generating care plan...</p>
                </div>

                <div class="success-message" id="success-message">
                    ‚úÖ Care plan generated successfully! Scroll down to ask questions.
                </div>

                <div class="error-message" id="error-message">
                    <!-- Error messages will appear here -->
                </div>

                <div class="care-plan" id="care-plan">
                    <h3>üéØ Your Personalized Care Plan</h3>
                    <div id="care-plan-content">
                        <!-- Care plan will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Step 2: Voice Chat -->
            <div class="step voice-section">
                <h2>üí¨ Step 2: Ask Questions About Your Recovery</h2>
                <p style="margin-bottom: 15px;">Click the microphone to ask questions about your condition, medications, or recovery process.</p>

                <button class="record-btn" id="record-btn" onclick="toggleRecording()">üé§</button>
                <p style="text-align: center; color: #64748b; margin-bottom: 15px;" id="record-status">Click to start recording</p>

                <!-- Text question area -->
                <div class="text-question-area">
                    <h4 style="margin-bottom: 10px;">Or type your question:</h4>
                    <input type="text" id="question-input" placeholder="Ask about pain levels, activity restrictions, medication side effects, etc.">
                    <button class="ask-btn" onclick="askTextQuestion()" id="ask-btn">Ask Heidi AI</button>
                </div>

                <div class="chat-response" id="chat-response">
                    <h4>ü§ñ Heidi AI Response:</h4>
                    <div id="ai-response-content"></div>
                </div>

                <div class="loading" id="voice-loading">
                    <div class="spinner"></div>
                    <p>Processing your question...</p>
                </div>

                <div class="error-message" id="question-error-message">
                    <!-- Question error messages will appear here -->
                </div>
            </div>

            <!-- Step 3: Daily Tracking -->
            <div class="step">
                <h2>üìä Step 3: Track Your Progress</h2>
                <p style="margin-bottom: 15px;">View your interactive care dashboard with medication reminders, activity tracking, and progress monitoring.</p>
                <button class="btn" onclick="openDashboard()">üì± Open My Care Dashboard</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let currentSessionId = null;

        // Utility functions
        function showElement(elementId) {
            const element = document.getElementById(elementId);
            if (element) element.classList.add('show');
        }

        function hideElement(elementId) {
            const element = document.getElementById(elementId);
            if (element) element.classList.remove('show');
        }

        function showError(message, elementId = 'error-message') {
            const errorElement = document.getElementById(elementId);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.classList.add('show');
            }
            console.error('Error:', message);
        }

        function hideAllMessages() {
            hideElement('error-message');
            hideElement('question-error-message');
            hideElement('success-message');
        }

        // File upload handling (keep original design, but add API call option)
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            hideAllMessages();
            showElement('upload-loading');
            hideElement('care-plan');

            // For now, we'll use mock data for file upload
            // In a real implementation, you'd extract text from the file first
            setTimeout(() => {
                generateMockCarePlan();
                hideElement('upload-loading');
                showElement('care-plan');
                showElement('success-message');

                setTimeout(() => {
                    hideElement('success-message');
                }, 3000);
            }, 3000);
        }

        // REAL API CALL - Document processing
        function processDocumentText() {
            console.log('=== PROCESS DOCUMENT TEXT CALLED ===');

            const documentText = document.getElementById('document-text').value.trim();
            if (!documentText) {
                showError('Please enter some discharge instructions first!');
                return;
            }

            hideAllMessages();
            showElement('upload-loading');
            hideElement('care-plan');

            // Disable button
            const processBtn = document.getElementById('process-btn');
            if (processBtn) {
                processBtn.disabled = true;
                processBtn.textContent = 'Processing...';
            }

            fetch('/process-document', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ document_text: documentText })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Response:', data);
                hideElement('upload-loading');

                if (data.success) {
                    currentSessionId = data.session_id;

                    // Display the real AI-generated care plan
                    const carePlanContent = data.care_plan || 'No care plan generated';
                    document.getElementById('care-plan-content').innerHTML = `
                        <div style="white-space: pre-wrap; font-family: inherit; line-height: 1.6;">
                            ${carePlanContent}
                        </div>
                    `;

                    showElement('care-plan');
                    showElement('success-message');

                    setTimeout(() => {
                        hideElement('success-message');
                    }, 3000);

                } else {
                    const errorMsg = data.error || 'Failed to generate care plan';
                    showError(errorMsg);
                }
            })
            .catch(error => {
                console.error('Network error:', error);
                hideElement('upload-loading');
                showError('Network error: ' + error.message);
            })
            .finally(() => {
                // Re-enable button
                if (processBtn) {
                    processBtn.disabled = false;
                    processBtn.textContent = 'üìã Generate Care Plan';
                }
            });
        }

        // REAL API CALL - Question answering
        function askTextQuestion() {
            console.log('=== ASK TEXT QUESTION CALLED ===');

            const questionInput = document.getElementById('question-input');
            const question = questionInput.value.trim();

            if (!question) {
                showError('Please enter a question first!', 'question-error-message');
                return;
            }

            hideElement('question-error-message');
            showElement('voice-loading');
            hideElement('chat-response');

            // Disable button
            const askBtn = document.getElementById('ask-btn');
            if (askBtn) {
                askBtn.disabled = true;
                askBtn.textContent = 'Asking...';
            }

            fetch('/ask-question', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    question: question,
                    session_id: currentSessionId
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Question response:', data);
                hideElement('voice-loading');

                if (data.success) {
                    currentSessionId = data.session_id;

                    const aiResponse = data.response || 'No response received';
                    document.getElementById('ai-response-content').innerHTML = `
                        <div style="white-space: pre-wrap; font-family: inherit; line-height: 1.6;">
                            ${aiResponse}
                        </div>
                    `;

                    showElement('chat-response');
                    questionInput.value = ''; // Clear input

                } else {
                    const errorMsg = data.error || 'Failed to get response';
                    showError(errorMsg, 'question-error-message');
                }
            })
            .catch(error => {
                console.error('Network error:', error);
                hideElement('voice-loading');
                showError('Network error: ' + error.message, 'question-error-message');
            })
            .finally(() => {
                // Re-enable button
                if (askBtn) {
                    askBtn.disabled = false;
                    askBtn.textContent = 'Ask Heidi AI';
                }
            });
        }

        // Voice recording (keep original functionality for now)
        async function toggleRecording() {
            const recordBtn = document.getElementById('record-btn');
            const recordStatus = document.getElementById('record-status');

            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        processVoiceQuestion(audioBlob);
                    };

                    mediaRecorder.start();
                    isRecording = true;
                    recordBtn.classList.add('recording');
                    recordBtn.textContent = '‚èπÔ∏è';
                    recordStatus.textContent = 'Recording... Click to stop';
                } catch (error) {
                    alert('Could not access microphone. Please use the text input instead.');
                    console.error('Microphone error:', error);
                }
            } else {
                mediaRecorder.stop();
                isRecording = false;
                recordBtn.classList.remove('recording');
                recordBtn.textContent = 'üé§';
                recordStatus.textContent = 'Processing your question...';
                showElement('voice-loading');
                hideElement('chat-response');

                // Stop all audio tracks
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
        }

        function processVoiceQuestion(audioBlob) {
            // For now, use mock responses for voice
            // In a real implementation, you'd send the audio to your backend
            setTimeout(() => {
                const responses = [
                    "Based on your surgery type, some discomfort is normal for the first few days. Take your pain medication as prescribed and get adequate rest. Contact your healthcare provider if pain becomes severe.",
                    "Light activities like short walks are encouraged as they help prevent blood clots and promote healing. However, avoid strenuous activities or heavy lifting as instructed.",
                    "Keep your incision clean and dry. Change dressing as directed and watch for signs of infection like increased redness, warmth, or unusual discharge.",
                    "Take your medications exactly as prescribed, even if you're feeling better. Completing the full course of antibiotics is especially important.",
                    "Some swelling and bruising around the surgical site is normal. Help reduce swelling by elevating the affected area and applying ice as directed."
                ];

                const randomResponse = responses[Math.floor(Math.random() * responses.length)];

                document.getElementById('ai-response-content').innerHTML = `
                    <div style="white-space: pre-wrap; font-family: inherit; line-height: 1.6;">
                        ${randomResponse}
                    </div>
                `;
                hideElement('voice-loading');
                showElement('chat-response');
                document.getElementById('record-status').textContent = 'Click to ask another question';
            }, 2000);
        }

        function generateMockCarePlan() {
            const carePlanContent = document.getElementById('care-plan-content');
            carePlanContent.innerHTML = `
                <div class="care-section">
                    <h3>üíä Medication Schedule</h3>
                    <div class="care-item">Pain medication (Ibuprofen 400mg) - Every 6 hours with food</div>
                    <div class="care-item">Antibiotic (Amoxicillin 500mg) - 3 times daily for 7 days</div>
                    <div class="care-item">Anti-nausea medication - As needed</div>
                </div>

                <div class="care-section">
                    <h3>üö∂ Activity Guidelines</h3>
                    <div class="care-item">Short walks (5-10 minutes) every 2 hours while awake</div>
                    <div class="care-item">No lifting over 10 pounds for 2 weeks</div>
                    <div class="care-item">Deep breathing exercises 3 times daily</div>
                </div>

                <div class="care-section">
                    <h3>ü©π Wound Care</h3>
                    <div class="care-item">Change dressing daily or when wet/dirty</div>
                    <div class="care-item">Keep incision dry for first 48 hours</div>
                    <div class="care-item">Watch for signs of infection: redness, swelling, unusual discharge</div>
                </div>

                <div class="care-section">
                    <h3>‚ö†Ô∏è When to Call Doctor</h3>
                    <div class="care-item">Fever over 101¬∞F (38.3¬∞C)</div>
                    <div class="care-item">Severe pain not controlled by medication</div>
                    <div class="care-item">Signs of infection at incision site</div>
                </div>

                <div class="care-section">
                    <h3>üìÖ Follow-up Appointments</h3>
                    <div class="care-item">Post-op check: 1 week from surgery date</div>
                    <div class="care-item">Suture removal: 10-14 days post-surgery</div>
                </div>
            `;
        }

        function openDashboard() {
            alert('üéâ Dashboard Feature Coming Soon!\n\nThis would open your personalized dashboard with:\n\nüì± Medication reminders\nüìä Progress tracking\nüìÖ Appointment schedule\nüö® Emergency contacts\nüìà Recovery milestones');
        }

        // Drag and drop functionality (keep original)
        const uploadArea = document.querySelector('.upload-area');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('file-input').files = files;
                handleFileUpload({ target: { files: files } });
            }
        });

        // Allow Enter key to submit questions
        document.getElementById('question-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                askTextQuestion();
            }
        });

        // Auto-focus on page load
        window.addEventListener('load', function() {
            console.log('üí° Demo Ready! Try pasting discharge instructions and asking questions.');
        });
    </script>
</body>
</html>